<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor de PDF Local</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    margin: 20px;
    text-align: center;
  }
  #pdf-container {
    position: relative;
    display: inline-block;
    border: 1px solid #ccc;
    background: white;
    touch-action: none; /* permite desenhar e controlar zoom */
  }
  canvas {
    display: block;
  }
  #overlay {
    position: absolute;
    top: 0;
    left: 0;
    cursor: crosshair;
  }
  .toolbar {
    margin-bottom: 10px;
  }
  button, select, input[type="range"] {
    padding: 8px 15px;
    margin: 3px;
    border: none;
    background-color: #0078d7;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover, select:hover, input[type="range"]:hover {
    background-color: #005fa3;
  }
</style>
</head>
<body>

<h2>Editor de PDF Local</h2>

<div class="toolbar">
  <input type="file" id="file-input" accept="application/pdf">
  <button id="draw-btn">‚úèÔ∏è Rabiscar</button>
  <label>Espessura:
    <input type="range" id="thickness" min="1" max="10" value="2">
  </label>
  <button id="text-btn">üî§ Adicionar Texto</button>
  <button id="remove-text-btn">‚ùå Remover Texto</button>
  <label>Zoom:
    <input type="range" id="zoom-control" min="0.5" max="3" step="0.1" value="1.2">
  </label>
  <button id="save-btn">üíæ Salvar PDF</button>
</div>

<div id="pdf-container">
  <canvas id="pdf-canvas"></canvas>
  <canvas id="overlay"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const fileInput = document.getElementById('file-input');
const pdfCanvas = document.getElementById('pdf-canvas');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const thicknessInput = document.getElementById('thickness');
const zoomControl = document.getElementById('zoom-control');
let drawing = false;
let mode = null;
let pdfPage, pdfScale = parseFloat(zoomControl.value);
let texts = [];
let redDot = null;
let pinchStartDistance = null;
let initialScale = pdfScale;

// === EXIBIR PDF ===
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function() {
    const typedArray = new Uint8Array(this.result);
    const pdf = await pdfjsLib.getDocument(typedArray).promise;
    pdfPage = await pdf.getPage(1);
    renderPDF();
  };
  reader.readAsArrayBuffer(file);
});

async function renderPDF() {
  const viewport = pdfPage.getViewport({ scale: pdfScale });
  const context = pdfCanvas.getContext('2d');
  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;
  overlay.width = viewport.width;
  overlay.height = viewport.height;

  const renderContext = { canvasContext: context, viewport: viewport };
  await pdfPage.render(renderContext).promise;

  redrawTexts();
}

// === MODOS ===
document.getElementById('draw-btn').onclick = () => mode = 'draw';
document.getElementById('text-btn').onclick = () => mode = 'text';
document.getElementById('remove-text-btn').onclick = () => mode = 'remove';
zoomControl.addEventListener('input', () => {
  pdfScale = parseFloat(zoomControl.value);
  renderPDF();
});

// === REDESENHAR TEXTOS ===
function redrawTexts() {
  ctx.clearRect(0, 0, overlay.width, overlay.height);
  texts.forEach(t => {
    ctx.font = "16px Arial";
    ctx.fillStyle = "black";
    ctx.fillText(t.text, t.x, t.y);
  });
}

// === RABISCO ===
function getPosition(e) {
  const rect = overlay.getBoundingClientRect();
  if (e.touches && e.touches[0]) {
    return {
      x: e.touches[0].clientX - rect.left,
      y: e.touches[0].clientY - rect.top
    };
  } else {
    return { x: e.offsetX, y: e.offsetY };
  }
}

function startDraw(e) {
  if (mode !== 'draw') return;
  drawing = true;
  const pos = getPosition(e);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
  e.preventDefault();
}

function draw(e) {
  if (!drawing || mode !== 'draw') return;
  const pos = getPosition(e);
  ctx.lineTo(pos.x, pos.y);
  ctx.strokeStyle = "black";
  ctx.lineWidth = parseInt(thicknessInput.value);
  ctx.stroke();
  e.preventDefault();
}

function endDraw() {
  drawing = false;
}

// === EVENTOS DE MOUSE ===
overlay.addEventListener('mousedown', startDraw);
overlay.addEventListener('mousemove', draw);
overlay.addEventListener('mouseup', endDraw);
overlay.addEventListener('mouseleave', endDraw);

// === EVENTOS DE TOQUE ===
overlay.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    startDraw(e);
  } else if (e.touches.length === 2) {
    // In√≠cio do zoom por pin√ßa
    pinchStartDistance = getTouchDistance(e);
    initialScale = pdfScale;
  }
});
overlay.addEventListener('touchmove', (e) => {
  if (e.touches.length === 1 && mode === 'draw') {
    draw(e);
  } else if (e.touches.length === 2) {
    // Controle de zoom por pin√ßa
    const newDistance = getTouchDistance(e);
    if (pinchStartDistance) {
      const zoomFactor = newDistance / pinchStartDistance;
      pdfScale = Math.min(Math.max(initialScale * zoomFactor, 0.5), 3);
      zoomControl.value = pdfScale.toFixed(2);
      renderPDF();
    }
  }
  e.preventDefault();
});
overlay.addEventListener('touchend', (e) => {
  endDraw();
  if (e.touches.length < 2) {
    pinchStartDistance = null;
  }
});

// === FUN√á√ÉO DIST√ÇNCIA DOS DEDOS ===
function getTouchDistance(e) {
  const [t1, t2] = e.touches;
  const dx = t2.clientX - t1.clientX;
  const dy = t2.clientY - t1.clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// === ADICIONAR TEXTO ===
overlay.addEventListener('click', (e) => {
  if (mode === 'text') {
    const x = e.offsetX;
    const y = e.offsetY;

    // ponto vermelho tempor√°rio
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fillStyle = "red";
    ctx.fill();
    redDot = { x, y };

    setTimeout(() => {
      const texto = prompt("Digite o texto:");
      if (texto) {
        texts.push({ text: texto, x, y });
        redrawTexts();
      }
      if (redDot) {
        redrawTexts();
        redDot = null;
      }
    }, 200);
  } else if (mode === 'remove') {
    const x = e.offsetX;
    const y = e.offsetY;
    texts = texts.filter(t => Math.hypot(t.x - x, t.y - y) > 20);
    redrawTexts();
  }
});

// === SALVAR PDF ===
document.getElementById('save-btn').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const combinedCanvas = document.createElement('canvas');
  combinedCanvas.width = pdfCanvas.width;
  combinedCanvas.height = pdfCanvas.height;
  const cctx = combinedCanvas.getContext('2d');
  cctx.drawImage(pdfCanvas, 0, 0);
  cctx.drawImage(overlay, 0, 0);

  const imgData = combinedCanvas.toDataURL("image/jpeg", 1.0);
  pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
  pdf.save('pdf_editado.pdf');
});
</script>

</body>
</html>
